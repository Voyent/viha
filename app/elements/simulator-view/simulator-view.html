<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../styles/shared-styles.html">
<script src="../../bower_components/papaParse/papaparse.js"></script>

<dom-module id="simulator-view">

  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }
    </style>
    <h2 class="page-title">Simulator</h2>
    <div style="display:flex; align-items:baseline; justify-content:space-around;">
      <div style="height:100%;display:inline-block;flex-shrink:2;">
        <h4>Simulations:</h4>
        <paper-radio-button checked on-click="setSim" id="simRadio"></paper-radio-button>
        <paper-dropdown-menu on-click="setSim" id="simulationSelect">
          <paper-listbox selected="0" class="dropdown-content">
            <template is="dom-repeat" items="{{simulationList}}">
              <paper-item>[[item]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
        <h4>Chosen files:</h4>
        <paper-radio-button on-click="setFile" id="fileRadio"></paper-radio-button>
        <input id="the-file-input" type="file">
      </div>
      <!--div style="height:100%;display:inline-block;flex-shrink:2;">
        <h4>Simulated Runspeed:</h4>
        <div style="display:flex; align-items:center">
          <div style="display:inline-block">
            <paper-slider  min="1" max="5" value="{{sliderValue}}" pin step="0.5"></paper-slider>
          </div>
          <div style="display:inline-block; ">
            <span style="display:inline-block;">[[sliderValue]]</span>X speed
          </div>
        </div>
      </div-->
      <div style="height:100%;display:inline-block;flex-shrink:2;">
        <!--h4>Simulated Start Time:</h4>
        <div>
          <select id="hourSelect">
            <template is="dom-repeat" items="{{hourCounts}}">
              <option value="[[item]]">[[item]]</option>
            </template>
          </select>
           :
          <select id="minuteSelect">
            <template is="dom-repeat" items="{{minuteCounts}}">
              <option value="[[item]]">[[item]]</option>
            </template>
          </select>
        </div-->
        <h4>Off Hours:</h4>
        <div style="width:230px">
          <paper-toggle-button on-click="toggleHours" checked="{{offHours}}">Currently: {{offHoursString}}</paper-toggle-button>
        </div>
      </div>
      <div style="height:100%;display:inline-block; margin-top:30px; flex-shrink:2; align-self:center;text-align:center;">
        <paper-button raised on-click="buttonPress">[[runString]]</paper-button>
        <br/>
        <div style="text-align:center;">Currently running:</div>
        <div style="text-align:center;"><span>[[currentEvent]]</span>/<span>[[totalEvents]]</span></div>
        <br/>
        <div style="text-align:center;">
          <!--span on-click="resumeArray">Resume</span>      <span on-click="pauseArray">Pause</span-->
          <template is="dom-if" if="{{canRun}}">
            <template is="dom-if" if="{{running}}">
              <paper-icon-button on-click="pauseArray" src="../../images/pause.png"></paper-icon-button>
            </template>
            <template is="dom-if" if="{{!running}}">
              <paper-icon-button on-click="resumeArray" src="../../images/play.png"></paper-icon-button>
            </template>
          </template>
        </div>
      </div>

    </div>
    <!--br/><br/>
    <hr/>
    <h2 class="page-title">Live Data:</h2>
    <div style="display:flex; align-items:baseline; justify-content:space-between;">
      <div style="height:100%; flex-basis:40%; display:flex; flex-direction:column;">
        <template is="dom-repeat" items="{{machineList}}">
          <div style="display:flex; flex-direction:row; justify-content:space-between;">
            <div style="display:inline-block">
              <span>[[item]]</span>
            </div>
            <div style="display:inline-block">
                <select id$="[[item]]" on-click="setComputer" class="statusList">
                  <template is="dom-repeat" items="{{statusList}}">
                    <option value="[[item]]">[[item]]</option>
                  </template>
                </select>
            </div>
          </div>
          <br/>
        </template>
      </div>

      <div style="height:100%;display:inline-block">
        <h4>Live Runspeed:</h4>
        <div style="display:flex; align-items:center">
          <div style="display:inline-block">
            <paper-slider  min="1" max="15" value="{{liveSliderValue}}" pin step="0.5"></paper-slider>
          </div>
          <div style="display:inline-block; ">
            <span style="display:inline-block;">[[liveSliderValue]]</span>X speed
          </div>
        </div>
      </div>

      <div style="height:100%;display:inline-block; margin-top:30px; align-self:center"><paper-button raised on-click="liveButtonPress">[[liveStatus]]</paper-button></div>


    </div-->

  </template>
  <script>
  (function() {
    'use strict';
    var poly;
    Polymer({
      is: 'simulator-view',

      properties: {
        visible: {
          type: Boolean,
          notify: true,
          observer: '_visibleChanged'
        },
        startTime: {
          type: String,
          notify: true,
          reflectToAttribute:true
        },
        sliderValue: {'type':Number,value:1,notify:true},
        uploadedArray: {'type':Array, value:[]},
        inputSource: {'type':String, value:'Simulation', notify:true},
        simulationList:{'type':Array, value:['simulation1']},
        hourCounts:{'type':Array, value:['00','01','02','03','04','05','06','07','08','09','10','11','12','13','14','15','16','17','18','19','20','21','22','23']},
        minuteCounts:{'type':Array, value:['00','01','02','03','04','05','06','07','08','09','10','11','12','13','14','15','16','17','18','19','20','21','22','23','24','25','26','27','28','29','30','31','32','33','34','35','36','37','38','39','40','41','42','43','44','45','46','47','48','49','50','51','52','53','54','55','56','57','58','59']},
        machineList:{'type':Array, value:['machine1','machine2','machine3'],notify:true},
        statusList: {'type':Array,value:['OK','CATCH-UP','BACK-UP','STALE','PENDING','ERROR','OLD']},
        liveStatus: {'type':String,value:"Start", notify:true},
        liveRunning: {'type':Boolean,value:false,notify:false},
        liveTime: {'type':String,notify:true},
        liveSliderValue: {'type':Number,value:1,notify:true},
        currentEvent:{'type':Number,value:0,notify:true},
        totalEvents:{'type':Number,value:0,notify:true},
        running: {'type':Boolean,value:false},
        canRun:{'type':Boolean,value:false},
        offHours: {'type':Boolean,value:false,notify:true},
        offHoursString: {'type':String,value:'Business Hours',computed:'getHoursString(offHours)'},
        runString:{'type':String,value:'Run Simulation', computed:'getRunString(inputSource)'}
      },

      created: function(){
        poly = this;
      },

      ready: function () {
        poly = this;

        bridgeit.io.documents.getDocument({id:'vihaHours'}).then(function(document){
            poly.offHours = document.offHours;
        });

        $(poly.$$("#the-file-input")).change(function() {
          poly.setFile();
          Papa.parse(this.files[0],{'complete':function(results){
            console.log("Parsing complete:", results);
            var resultArray = results.data;
            var jsonArray = [];
            var headers = ['rowId','linkDescription','webSection', 'node', 'detailDesc','status','detail','time'];
            var startTime = 0;
            var lastTime = 0;
            for(var i = 0; i < resultArray.length; i++){
              var event = {'event':'update','service':'viha','type':'status', 'data':{}};
              for(var j = 0; j < headers.length; j++){
                event.data[headers[j]] = resultArray[i][j];
              }
              var rawTime = resultArray[i][7];
              var brokenTime = rawTime.split(":");
              var milliTime = ((((parseInt(brokenTime[0]) * 60) + parseInt(brokenTime[1])) * 60) + parseInt(brokenTime[2])) * 1000;
              if (startTime === 0){
                startTime = milliTime;
                lastTime = milliTime;
              }
              while(milliTime < lastTime){
                milliTime += 24*60*60*1000;
              }
              event.delay = milliTime - lastTime;
              lastTime = milliTime;
              jsonArray.push(event);
            }
            poly.uploadedArray = jsonArray;
            //bridgeit.io.documents.updateDocument({"collection":"simulations","id":"simulation1","document":{"array":jsonArray}});
          }});
        });

      },

      setSim: function(){
        poly.$$('#fileRadio').checked = false;
        poly.$$('#simRadio').checked = true;
        poly.inputSource = 'Simulation';
      },

      setFile: function(){
        poly.$$('#simRadio').checked = false;
        poly.$$('#fileRadio').checked = true;
        poly.inputSource = 'File';
      },

      getHoursString: function(hours){
        if(hours){
          return 'Off Hours';
        }
        else {
          return 'Business Hours';
        }
      },

      getRunString:function(run){
        return "Run " + run;
      },

      buttonPress : function(){

          bridgeit.io.event.stopEvents();
          poly.running = true;
          poly.canRun = true;
          //poly.startTime = poly.$$('#hourSelect').value + ':' + poly.$$('#minuteSelect').value;
          if (poly.inputSource === 'Simulation') {
            bridgeit.io.documents.getDocument({
              "collection": 'simulations',
              "id": poly.$$('#simulationSelect').value
            }).then(function (sim) {
              poly.runArray(sim.array);
            });
          }
          else {
            var activeArray = poly.uploadedArray;
            if (activeArray == []) {
              console.log('No uploaded data found.');
              return;
            }
            else {
              poly.runArray(JSON.parse(JSON.stringify(activeArray)));
            }
          }
      },

      runArray: function(activeArray){

        var currentTime = new Date();
        poly.currentEvent = bridgeit.io.event.getCurrentEvent();
        poly.totalEvents = bridgeit.io.event.getEventsSize();
        poly.updateInfo();
        //currentTime.setHours(poly.$$('#hourSelect').value);
        //currentTime.setMinutes(poly.$$('#minuteSelect').value);
        /** Below is part of accelerated time. Above is false start time
        currentTime.setHours(0);
        currentTime.setMinutes(0);
        currentTime.setSeconds(0);
         */
        for(var i = 0; i < activeArray.length; i++){
          if(poly.sliderValue !== 1){
            activeArray[i].delay /= poly.sliderValue;
          }
          currentTime = new Date(currentTime.getTime() + (activeArray[i].delay * poly.sliderValue));
          activeArray[i].data.time = currentTime.toLocaleTimeString("en-GB") + '.000';
        }
        console.log(activeArray);
        bridgeit.io.event.createCustomEvents({'eventArray':activeArray});
      },

      setComputer: function(e){
        var element = e.srcElement ? e.srcElement : e.target;
        var machineName = element.getAttribute('id');
        var status = $(element).val();
        var mailbox = {
          info:{
            'role':'machine'
          },
          state: {
            'status':status
          }
        };
        bridgeit.io.mailbox.updateMailbox({'id': machineName, 'mailbox': mailbox});
      },

      _visibleChanged: function(){
        bridgeit.io.mailbox.findMailboxes().then(function (users) {
          for (var i = 0; i < users.length; i++){
            if(users[i].info.role === 'machine'){
              $(poly.$$("#"+users[i]._id)).val(users[i].state.status);
            }
          }
        });
      },

      liveButtonPress: function(){
        if(!poly.liveRunning){
          poly.liveStatus = 'STOP';
          poly.liveRunning = true;
          var date = new Date();
          poly.liveTime = date.getTime();
          poly.runCycle();
        }
        else{
          poly.liveStatus = 'START';
          poly.liveRunning = false;
        }
      },

      runCycle: function(){
        var cycleTime = 5000;
        if(poly.liveRunning) {
          var date = new Date(poly.liveTime);
          for(var i = 0; i < poly.machineList.length; i++){
            var machine = poly.machineList[i];
            var status = $(poly.$$("#"+machine)).val();
            var event = { "event" : "update", "service" : "viha", "type" : "status",
              "data" : { "rowId" : "33203", "linkDescription" : "PROD_EXCELLERIS",
                "webSection" : "CRITICAL", "node" : machine, "detailDesc" : "test_machine",
                "status" : status,
                "detail" : "Detail stuff", "time" : date.toLocaleTimeString("en-GB") + '.000' }};
            bridgeit.io.event.createCustomEvent({"event":event})
          }
          setTimeout(function () {
            poly.liveTime += (cycleTime * poly.liveSliderValue);
            poly.runCycle();
          }, cycleTime);
        }
      },

      updateInfo:function(){
        setTimeout(function(){
          poly.currentEvent = bridgeit.io.event.getCurrentEvent();
          poly.totalEvents = bridgeit.io.event.getEventsSize();
          if(poly.currentEvent !== poly.totalEvents){
            poly.updateInfo();
          }
          else{
            poly.canRun = false;
          }
        },500)
      },

      resumeArray:function(){
        console.log('Resume');
        poly.running = true;
        bridgeit.io.event.restartEvents({});
      },

      pauseArray:function(){
        console.log('Pause');
        poly.running = false;
        bridgeit.io.event.stopEvents();
      },

      toggleHours:function(){
        if(this.offHours){
          bridgeit.io.documents.updateDocument({id:'vihaHours',document:{'offHours':true}});
        }
        else {
          bridgeit.io.documents.updateDocument({id:'vihaHours',document:{'offHours':false}});
        }

      }


    });
  })();
  </script>
</dom-module>



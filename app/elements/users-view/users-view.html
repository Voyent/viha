<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../styles/shared-styles.html">

<dom-module id="users-view">
<template>
    <style include="shared-styles">
        :host {
            display: block;
        }

        .avatar {
          display: inline-block !important;
          box-sizing: border-box;
          width: 40px;
          height: 40px;
          border-radius: 50%;
        }

        paper-icon-item{
            background-color: #FFF;
            border-bottom: 1px solid #EEE;

        }

        paper-icon-item ::content > div{
            padding: 20px;
        }

        .username{
            width: 100px;
            font-weight: bold;
            font-size: 18px;
        }

        iron-selector ::content > * {
            padding: 8px;
            min-width: 100px;
        }

        .userParent{
          display:table-row;
        }

        .cell{
          display:table-cell;
        }

        /* CSS specific to IE10+ */
        @media all and (-ms-high-contrast: none), (-ms-high-contrast: active) {
          .username{
            min-width:120px; /* Ensure the usernames line up  */
          }
        }
    </style>
    <h2 class="page-title">Users</h2>
    <template is="dom-if" if="{{visible}}">
        <paper-material id="topLevel" style="display:table">
            <template is="dom-repeat" items="{{users}}">
                <paper-icon-item id="[[item._id]]" class="userParent" style="display:flex;align-content: center">
                    <iron-icon icon="account-circle" item-icon class="avatar cell"></iron-icon>
                    <div class="item-body username cell">
                        <div class="flex">{{item._id}}</div>
                    </div>
                    <div class="flex cell" style="margin-top:-15px;">
                        <paper-dropdown-menu>
                            <iron-selector class="dropdown-content roleSelect" attr-for-selected="name"
                                           >
                              <div on-click="updateUser" name="manager">Manager</div>
                              <div on-click="updateUser" name="team">Team</div>
                            </iron-selector>
                        </paper-dropdown-menu>
                    </div>
                    <div class="flex routesDiv regionSelect cell">
                      On Call:
                      <paper-checkbox on-click="onCallSelect" class="onCallButton"></paper-checkbox>
                    </div>

                </paper-icon-item>
            </template>
        </paper-material>
    </template>
</template>
<script>
    (function () {
        'use strict';
        var poly;

        Polymer({
            is: 'users-view',

            properties: {
                visible: {
                    type: Boolean,
                    notify: true,
                    observer: '_visibleChanged'
                },
                users: {
                    type: Array,
                    notify: true,
                    value: []
                },
                regions: {
                    type: Array,
                    notify: true,
                    value: []
                }
            },

            ready: function () {
                poly = this;
            },

            _visibleChanged: function () {
                if (this.visible) {
                  if (poly.users.length === 0) {
                    poly.loadUsers();
                  }
                  else {
                    poly.updateToggles();
                  }
                }
            },

            updateUser: function (e,rawElement) {
                setTimeout(function () {
                    var username;
                    if(rawElement === true){
                      username = e.closest('.userParent').getAttribute('id');
                    }
                    else{
                      var node = e.srcElement? e.srcElement.closest('.userParent'): e.target.closest('.userParent');
                      username = node.getAttribute('id');
                    }
                    var mailbox = {
                      info: {
                        role: poly.$$('#' + username.split('.').join('\\.')).querySelector('.roleSelect').querySelector('.iron-selected').getAttribute('name')
                      },
                      state: {
                        onCall: poly.$$('#' + username.split('.').join('\\.')).querySelector('.onCallButton').getAttribute('checked') !== null
                      }
                    };
                    bridgeit.io.mailbox.updateMailbox({'id': username, 'mailbox': mailbox});
                }, 10);
            },

            loadUsers: function () {
              //TODO: Add functionality for different mailbox holding.
                bridgeit.io.mailbox.findMailboxes().then(function (tempUsers) {
                    var users = [];
                    for (var i = 0; i < tempUsers.length; i++){
                      if(tempUsers[i].info.role !== 'machine'){
                        users.push(tempUsers[i]);
                      }
                    }
                    poly.set('users',users);
                    poly.updateToggles();
                });
            },

            updateToggles: function () {
              function doToggleUpdate(user) {
                setTimeout(function () {
                  if (user.state.onCall) {
                    poly.$$('#' + user._id.split('.').join('\\.')).querySelector('.onCallButton').setAttribute('checked', 'checked');
                  }

                  poly.$$('#' + user._id.split('.').join('\\.')).querySelector('.roleSelect').setAttribute('selected',user.info.role);
                },10);
              }
              for (var i=0; i<poly.users.length; i++) {
                doToggleUpdate(poly.users[i]);
              }
            },

          driverTest: function(item){
            return item.info.role === 'driver';
          },

          onCallSelect:function(e){
            //console.log(e);
            //var buttons = Polymer.dom(poly.$$('#topLevel')).querySelectorAll(".onCallButton");
            /**for (var i = 0; i < buttons.length; i++){
              if( buttons[i] != e.srcElement.closest('.onCallButton')){
                if(buttons[i].checked){
                  buttons[i].checked = false;
                  poly.updateUser(buttons[i],true);
                }
              }
            }*/
            poly.updateUser(e,false);
          }
        });
    })();
</script>
</dom-module>

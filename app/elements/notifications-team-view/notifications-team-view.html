<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../styles/shared-styles.html">

<dom-module id="notifications-team-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }

      .notifications paper-item{
        font-size: 12px;
      }

      paper-material{
        padding: 20px;
        background-color: #FFF;
      }
      paper-item-body ::content > * {
        white-space: normal;
      }
      paper-icon-item{
        border-bottom: 1px solid #EEE;
        padding: 10px 0;
      }
      paper-icon-item:first-child{
        padding-top: 0;
      }
      paper-icon-item:last-of-type{
        border-bottom: none;
        padding-bottom: 0;
      }

      .wrapperDiv {
        height:75px;
        width: 100%;
      }
      paper-header-panel {
        background-color:white;
        box-shadow:0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
        height:100%;
        margin:12px;
        width:100%;
      }
      .paper-header {
        background-color:#2A415E;
        color:white;
        text-align:center;
        transition:height 0.2s ease 0s;
      }
      .content {
        padding-top:10px;
        text-align:center;
      }
      paper-button.clear {
        font-size: small;
        height: 20px;
        padding-top: 3px;
        position: absolute;
        right: 5px;
        top: 5px;
        width: 40px;
      }
      .navDiv{
        height:auto;
        display:inline-flex;
        flex-direction:column;
        justify-content:center;
      }
    </style>

    <!--h2>Current Message:</h2-->
    <div style="display:flex; justify-content:center;"><h2>Notification Info:</h2></div>
    <div style="display:flex; justify-content:space-between; width:100%">
      <div class="navDiv">
        <template is="dom-if" if="[[hasLast]]">
          <paper-icon-button on-click="goBack" src="../../images/back.png"></paper-icon-button>
        </template>
      </div>
      <div style="flex-grow:4;">

        <br/>
        <div>
        Description: <span data-metadata-desc></span><br/><br/>
        Group: <span data-metadata-group></span><br/><br/>
        Sent At: <span data-metadata-time></span><br/><br/>
        </div>
        <h4>Responses:</h4>
        <div>
          <!--paper-button raised>Acknowledge</paper-button-->
          <paper-button raised on-click="deleteNotification">Delete</paper-button>
          <paper-button raised on-click="getData">Check Machine</paper-button>
        </div>
      </div>
      <div class="navDiv">
        <template is="dom-if" if="[[hasNext]]">
          <paper-icon-button on-click="goForward" src="../../images/forward.png"></paper-icon-button>
        </template>
      </div>
    </div>
    <!--template is="dom-if" if="{{notificationSelected}}">
      <div class="wrapperDiv">
        <!--paper-header-panel>
          <div class="paper-header" data-metadata-desc></div>
          <div class="content">
            <paper-button raised on-click="fireEvent" data-response="Acknowledge" data-result="ack">Acknowledge</paper-button>
          </div>
        </paper-header-panel>
      </div>
    </template>
    <!--template is="dom-if" if="{{!notificationSelected}}">
      No notification to display.
    </template>

    <h2>Search Past Data:</h2>
    <div style="width:100%;display:flex; align-content:center">
      <paper-button on-click="getData" raised>Historic Data</paper-button>

    </div>
    </div-->
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'notifications-team-view',

        properties: {
          visible: {
            type: Boolean,
            notify: true,
            observer:"loadNotification"
          },
          notificationSelected: {
            type: Boolean,
            value: false
          },
          messages: {
            type: Array,
            value:[]
          },
          message: {
            type: String,
            value:null
          },
          time: {
            type: String,
            value:null,
            notify:true,
            reflectToAttribute:true
          },
          hasMessages: {
            type: Boolean,
            computed: '_computeHasMessages(messages.splices)'
          },
          selectednode:{
            type:String,
            notify:true,
            reflectToAttribute:true
          },
          route: {
            type: String,
            notify: true,
            reflectToAttribute:true
          },
          selecteddetail:{
            type:String,
            notify:true,
            reflectToAttribute:true
          },
          selectedgroup:{
            type:String,
            notify:true,
            reflectToAttribute:true
          },
          selectedtime:{
            type:String,
            notify:true,
            reflectToAttribute:true
          },
          hasNext:{
            type:Boolean,
            notify:true
          },
          hasLast:{
            type:Boolean,
            notify:true
          }
        },

        loadNotification: function() {
          if (bridgeit.notify.payload && bridgeit.notify.metadata) {
            this.notificationSelected = true;
            bridgeit.notify.clearInjectedNotificationData();
            this.notificationSelected = true;
            bridgeit.notify.injectNotificationData();
            this.message = bridgeit.notify.metadata.desc;
            this.time = bridgeit.notify.metadata.time;
            this.hasNext = bridgeit.notify.getNextNotification() !== null;
            this.hasLast = bridgeit.notify.getPreviousNotification() !== null;
            //this.queue = bridgeit.notify._queue;
            //console.log(bridgeit.notify);
          }
          else {
            this.notificationSelected = false;
          }
        },

        deleteNotification:function(){
          console.log('In the right place');

          if(this.hasNext){
            var next = bridgeit.notify.getNextNotification();
            bridgeit.notify.removeSelectedNotification();
            bridgeit.notify.selectNotification(next);
            this.loadNotification();
          }
          else if(this.hasLast){
            var back = bridgeit.notify.getPreviousNotification();
            bridgeit.notify.removeSelectedNotification();
            bridgeit.notify.selectNotification(back);
            this.loadNotification();
          }
          else{
            bridgeit.notify.removeSelectedNotification();
            page.redirect('/notifications');
          }
        },

        goBack:function(){
          bridgeit.notify.selectNotification(bridgeit.notify.getPreviousNotification());
          this.loadNotification();
        },

        goForward:function(){
          bridgeit.notify.selectNotification(bridgeit.notify.getNextNotification());
          this.loadNotification();
        },

        fireEvent: function(e) {
          console.log('e',e);
          /*var _this = this;
          var event = {
            "service":"foo",
            "event":"bar",
            "type":"foobar",
            "data":{
              "result":e.target.getAttribute('data-result'),
            }
          };

          bridgeit.io.metrics.createCustomEvent({"event":event}).then(function() {
            //remove notification from queue
            _this.message = '';
            var notification = bridgeit.notify.getSelectedNotification();
            notification.response = e.target.getAttribute('data-response');
            _this.push('messages',notification);
            bridgeit.notify.removeSelectedNotification();
          }).catch(function(error) {
            console.log('Error in createCustomEvent:',error);
          });*/
        },

        _computeHasMessages: function(){
          return this.messages && this.messages.length;
        },

        sortNotifications: function(a,b) {
          if (a.metadata.time > b.metadata.time) { return -1; }
          else if (a.metadata.time < b.metadata.time) { return 1; }
          return 0;
        },

        resetMessages: function(){
          this.messages = [];
        },

        getData:function(){
          this.set('selectednode',"");
          this.set('selecteddetail',"");
          this.set('selectedgroup',"");
          var postColon = this.message.split(':')[1];
          var node = postColon.split('/')[1].trim();
          this.set('selectednode',node);
          var detail = postColon.split('/')[2].trim();
          this.set('selecteddetail',detail);
          var group = postColon.split('/')[0].trim();
          this.set('selectedgroup',group);
          var data = document.querySelector("data-view");
          data.historyCheck();
          this.set('route','data');
        }
      });
    })();
  </script>
</dom-module>
